<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Cao Yong,ednencaox@gmail.com"><title>Draft.js的事件处理机制 · Eden's Blog</title><meta name="description" content="Draft 事件处理机制Draft.js 内部封装了一系列基础的事件处理函数，当事件触发时，这些函数接收当前event，并基于此生成new editorState，我们在接收到new editorState后再将该数据绑定到Draft上，这就是Draft的单向数据流。其中react层只负责视图层，我"><meta name="keywords" content="JavaScript,TypeScript,Linux,macOS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/blog/css/style.css"><link rel="stylesheet" href="/blog/css/blog_basic.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><link rel="stylesheet" href="/blog/css/atom-one-light.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/blog/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">Eden's Blog</a></h3><div class="description"><p>一些奇奇怪怪的东西</p></div></div></div><ul class="social-links"><li><a href="http://github.com/EdenCao"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="archives/">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Draft.js的事件处理机制</a></h3></div><div class="post-content"><h1 id="Draft-事件处理机制"><a href="#Draft-事件处理机制" class="headerlink" title="Draft 事件处理机制"></a>Draft 事件处理机制</h1><p>Draft.js 内部封装了一系列基础的事件处理函数，当事件触发时，这些函数接收当前<code>event</code>，并基于此生成<code>new editorState</code>，我们在接收到<code>new editorState</code>后再将该数据绑定到<code>Draft</code>上，这就是Draft的单向数据流。其中<code>react</code>层只负责视图层，我们将通过一些流程图与源码的展示来详细介绍这一点。</p>
<h2 id="事件在-Draft-内部的传递"><a href="#事件在-Draft-内部的传递" class="headerlink" title="事件在 Draft 内部的传递"></a>事件在 Draft 内部的传递</h2><p><img src="//upload-images.jianshu.io/upload_images/5617469-b27a9ec7b9eff1a5.png" alt="eventInDraft.png"><code>Draft</code> 由事件驱动，任何事件的触发最终都会被转化为一个新的<code>EditorState</code>。上图是一个简单的流程图，展现了事件在 Draft 内部的传递机制。</p>
<p><code>react</code>只负责事件的绑定与<code>view</code>的展示，将<code>Draft</code>中内置的事件<code>editorBlur</code>等方法与原生事件<code>blur</code>进行绑定，下面给出了<code>Draft</code>源码进行说明：</p>
<pre><code>// DraftEditor.react.js

// 经过精简
render() {
    &lt;div
        // 将原生事件与Draft内置事件相绑定
        onBeforeInput={this._onBeforeInput}
        onBlur={this._onBlur}
        onCopy={this._onCopy}
        onCut={this._onCut}
        onDragEnd={this._onDragEnd}
        onDragEnter={this.onDragEnter}
        ...

        // 请暂时忽略下面这部分
        &lt;DraftEditorContents {...editorContentsProps} /&gt;
    &lt;/div&gt;
  }
</code></pre><p>通过上面的代码部分我们可以看到，react将原生事件与内置事件做了绑定，例如将<code>_onBlur</code>绑定到了原生事件<code>onBlur</code>上面。而_onBlur内部的事件则被单独抽象出来，与视图层完全解耦。</p>
<p><code>Draft</code>运用了一些很酷的小技巧来解决内置事件与原生事件的绑定问题：</p>
<pre><code>// 经过精简
import React, { Component } from &#39;react&#39;;
import {onBlur, onCopy, onFocus} from &#39;./logicLayer&#39;;

const handler = {
  onBlur(e) {
    editOnBlur(e);
  }
  onCopy(e) {
    editOnCopy(e);
  }
  onFocus(e) {
    editonFocus(e);
  }
}

class DraftEditor extends Component {
  constructor(props){
    super(props);

    // 事件绑定
    this._onBlur = this._buildHandler(&#39;onBlur&#39;);
    this._onCopy = this._buildHandler(&#39;onCopy&#39;);
    this._onCut = this._buildHandler(&#39;onCut&#39;);
    this._onInput = this._buildHandler(&#39;onInput&#39;);
    ...
  }

  _buildHandler(eventName) {
    return e =&gt; {
      const method = this._handler &amp;&amp; this.handler[eventName];
      method &amp;&amp; method(this, e);
    }
  }
}
</code></pre><p>核心函数是<code>_buildHandler</code>,通过此函数进行事件绑定的分发。</p>
<p>通过这种方式，可以完成视图层与逻辑层的解耦。</p>
<p>任何事件的触发最后都会被转化为一个<code>new EditorState</code>,通过onChange（update）方法抛出，我们接收到<code>new EditorState</code>后，再将其绑定到<code>Draft</code>上面，由<code>Draft</code>负责<code>EditorState</code>的转换，最终通过react渲染出来。</p>
<p>也就是说，任何<code>new EditorState</code>都一定会被<code>Draft</code>抛给我们，再由我们绑定到<code>Draft</code>上面进行展示，<code>EditorState</code>不是一个内部状态。</p>
<p>当然<code>Draft</code>对EditorState进行转换的过程远远没有这么简单，实际情况要复杂的多，这点我们将会在下面提到。</p>
<p>通过上面所提到的这种方式，<code>Draft</code>完成了由事件到状态对象的转化，并且完成了数据的单向流动。</p>
<h2 id="Draft-事件层和展示层的分离"><a href="#Draft-事件层和展示层的分离" class="headerlink" title="Draft 事件层和展示层的分离"></a>Draft 事件层和展示层的分离</h2><p><img src="//upload-images.jianshu.io/upload_images/5617469-6125572d566da98e.png" alt="Event&amp;View.png">我在上面大致画出了<code>draft</code>的<code>react</code>层是如何划分的。其实这个图并不准确，但是用来说明已经够用了。</p>
<p>在<code>react</code>层将事件绑定层与实践展示层分离：</p>
<pre><code>// DraftEditor.react.js
// 经过精简


/**
 * Event层
 */
render() {
    &lt;div
        // 将原生事件与Draft内置事件相绑定
        onBeforeInput={this._onBeforeInput}
        onBlur={this._onBlur}
        ...

        /**
         * View 层
         */
        &lt;DraftEditorContents {...editorContentsProps} /&gt;
    &lt;/div&gt;
  }
</code></pre><p>仔细查看上面的代码，依旧是相同的<code>render</code>函数，这次我将事件绑定的部分隐去了大部分，主要可以看到在这个组件中引入了<code>DraftEditorContents</code>组件，这个组件就是事件的展示层。在此层中，储存了<code>preEditorStatus</code>,<code>View</code>层负责将<code>diff</code>过后的<code>latestEditorStatus</code>渲染出来。</p>
<p>中间会经过一些过程，在此期间<code>Draft</code>会向外暴露一些端口用于处理类似于<code>block</code>样式与<code>inline</code>样式，具体内容会在扩展中提及。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-05-06</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,//edencao.github.io/blog/2019/05/06/Draft.js-Event-Handling-Mechanism/,Eden's Blog,Draft.js的事件处理机制,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/blog/2019/05/06/Talk-About-Rem-And-Vw----Rem/" title="谈谈 rem 与 vw -- rem">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/blog/2019/05/06/From-Implementing-A-Traffic-Light-To-Functional-Programming/" title="从实现一个红绿灯到函数式编程">下一篇</a></li></ul></div><div class="gitment" id="comments"></div><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var styleElm = document.createElement('link');
styleElm.rel = 'stylesheet'; 
styleElm.href = 'https://imsun.github.io/gitment/style/default.css';
document.head.appendChild(styleElm)

var gitment = new Gitment({
    id: document.querySelector('.post-title').textContent.split(' ').join('_'),
    owner: 'EdenCao',
    repo: 'blog',
    oauth: {
        client_id: '524a2ec70d9f93b7d96f',
        client_secret: '403fd7b08932eb72291927b7c5bb6e574f7aa379'
    }
});
gitment.render('comments')</script></div></div></div></div><script src="/blog/js/jquery.js"></script><script src="/blog/js/jquery-migrate-1.2.1.min.js"></script><script src="/blog/js/jquery.appear.js"></script><script src="/blog/js/highlight.pack.js"></script><script>hljs.configure({
  tabReplace: '  ',
})
hljs.initHighlightingOnLoad();</script></body></html>